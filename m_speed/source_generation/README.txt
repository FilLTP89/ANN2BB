This is short user guide for using SPEED_GUI_4_INPUT program for the generation of input files for SPEED,
whenever a coputational model with an extended fault source is considered.

%===============================================================================================================================%
Section 1. Short description of the materials in MAKE_SPEED_INPUT folder:

MAKE_SPEED_INPUT contains:

- SPEED_GUI_4_INPUT.m: matlab program (GUI) that generates input files for SPEED
              when a reaistic earthquake scenario is considered.
              SPEED_GUI_4_INPUT uses Matlab routines contained in the src folder.
              
- SPEED_4_INPUT.m: matlab program (NO-GUI) that generates input files for SPEED
              when a reaistic earthquake scenario is considered.
              SPEED_4_INPUT uses Matlab routines contained in the src folder.             

- ncdumps.exe, ncdumps.sh: executable scripts for converting files exported from cubit (exodus .e) 
                           to text files (ascii .txt). See Section 4 for details.


- SCENARIOS: Database for earthquake scenarios and contains:

	a) Subdirectories Lxxx representing a selected location with id xxx.
	   The number xxx can range from 001 to 999. In particular:
	   L000 = New scenario repository (see Section 3 for details.) 
	   L001 = Santiago de Chile
	   L002 = Emilia Romagna
	   L003 = ChristhChurch
	   L004 = Wellington 
           
           Each folder Lxxx contains subdirectories named Fyyyyy, where the number yyyyyy ranges from 1 to 99999.
           Fyyyyy represents the id of the selected seismic fault for the location Lxxx, 
           according to the webpage http://95.110.233.181/terremoti. Examples:
           - for location L001 (Santiago) we have fault F00001 (i.e., San Ramon fault)
           - for location L002 (Emilia) we have faults F00011 (i.e., Mirandola fault) 
                               and F00012 (i.e., Ferrara fault)
           - for location L003 (Christchurch) we have faults F00021 F00022 F00023
		   
		   - for location L004 (Wellington) we have faults F00031
                     
           The couple Lxxx/Fyyyyy selects the numerical model for the given earthquake scenario. 
           Mesh files generated by CUBIT (https://cubit.sandia.gov/) and then exported in exodus format (.e)
           should be saved in the subdirectory cub.            
           In particular the directory cub should contain:
           	a1)  mesh of the domain (Example: L002/F00012/cub/EmiliaF12.e)
           	a2)  mesh of the fault (Example: L002/F00012/cub/fault.e)
           	     ATTENTION: The name fault.e is mandatory
           	a3)  mesh of the alluvial basin (Example: L002/F00012/cub/ALL.e) 
           	     ATTENTION: The name ALL.e is mandatory
                a4)  mesh of the topography (Example: L002/F00012/cub/XYZ.e) 
           	     ATTENTION: The name XYZ.e is mandatory
           	a5)  list of the monitored points, here descibed as a mesh. (Example: L002/F00012/cub/monitors.e) 
           	     ATTENTION: The name monitors.e is mandatory    	   
	   
	        Note that inputs a3) and a4) are needed if the Not-Honoring strategy is used (see Section 2).  
	        
	         
	   The directory mate contains the material properties associated with the different domains of the mesh.
	   In particular:
	   	a6)  materials.ini:  list of mechanical properties of different materials along with boundary
	   	     and interface conditions (for DG-SEM method) (Example: L002/F00012/mate/materials.ini)
	   	     The following format is used: 
	   	  Material_ID	 Spectral_Degree(SD)  rho(kg/m3)  Vp(m/s)   Vs(m/s)  Qp(-)  Qs(-)   f_max(Hz)    	
                      1 ...
                      2 ...
                      .
                      .
                      .
                      N ...
                      N+1  ABSO
                      N+2  DGIC 1
                      N+3  DGIC 0 
                      STOP

        Example (SEM simulation): 
	   1          3         2800      6340      3670    600  350       2                  
           2          3         2800      6340      3670    600  350       2                    
           3          3         2000      1700      1000    170  100       2                   
           4          3         2200      2700      1600    270  150       2                   
           5          3         2500      3700      2200    370  200       2                    
           6          3         2800      6340      3670    600  350       2                                                      
           7  	    abso                                                                              
           STOP   
             
        Example (DGSEM simulation): 
	   1          3         2800      6340      3670    600  350       2                  
           2          3         2800      6340      3670    600  350       2                    
           3          3         2000      1700      1000    170  100       2                   
           4          3         2200      2700      1600    270  150       2                   
           5          3         2500      3700      2200    370  200       2                    
           6          3         2800      6340      3670    600  350       2                                                      
           7  	    abso
           8        dgic  1
           9        dgic  0                                                                              
           STOP   

	   Note: the first N rows, from 1 to N, provide the material information of the corresponding domains of the mesh. 
		 The following rows provide the boundary (e.g., abso) and interface conditions (e.g., dgic). 
		 The files ends with the string "STOP". 
					 
					
	   	a7)  curve_damp.ini: description of the curve strain vs damping 
	   	     for non linear materials (Example: L002/F00012/mate/curve_damp.ini). 
	   	     The following format is used: 
	   	     1st column: strain (-)
	   	     2nd column: damping ratio (-) 	   	     
	   	a8)  curve_GG0.ini: description of the curve strain vs G/G0 
	   	     for non linear materials (Example: L002/F00012/mate/curve_GG0.ini)
	   	     The following format is used: 
	   	     1st column: strain (-)
	   	     2nd column: G/Gmax (-), where Gmax is the small strain shear modulus 
	   	      	  	
	   In the directory sism info for the extended fault of the parent directory are saved. In particular:
	   	a9)  fault.dat contains the description of fault parameters 
	   	     (Example: L002/F00012/sism/fault.dat)
	   	     Fault data are printed in a single row, size [1x14], listing the following information:
	   	     1st column: Fault id (e.g. 12 for F00012) 
	   	     2nd column: Fault Lenght = Max length Lmax of the fault as implemented in the numerical model (in m)
	   	     3rd column: Fault Width = Max width Wmax of the fault as implemented in the numerical model (in m)
	   	     4th column: Strike = strike angle (in degrees)
	   	     5th column: Dip = dip angle (in degrees)
	   	     6th column  rake = rake angle (in degrees)
                     7th column: FO_x = X coordinate (in m) of the Fault Origin FO, 
	   	                 i.e. uppermost fault point at zero strike and zero dip. 
	   	     8th column: F0_y = Y coordinate (in m) of the Fault Origin FO, 
	   	                 i.e. uppermost fault point at zero strike and zero dip.
	   	     9th column: F0_z = Z coordinate (in m) of the Fault Origin FO, 
	   	                 i.e. uppermost fault point at zero strike and zero dip.
	   	     
	   	     Example:
	   	     12 45000 30000 114 40 80 665972.1610 4985800.6357 0.0
	   	     
	   	a10) hypocenter.dat contains a list of possible hypocenters for the fault Fyyyyy.
	   	     (Example: L002/F00012/sism/hypocenter.dat)
	   	     Data are arranged in a 2D array with size [Nhypo x 3], where Nhypo is the total number of possible 
	   	     hypocenter locations to be included in the simulations. 
	   	     The ith row (i=1:Nhypo) provides the following information:  
	   	     1st column: X coordinate of hypocenter (as adopted in the numerical model)
	   	     2nd column: Y coordinate of hypocenter (as adopted in the numerical model)
	   	     3rd column: Z coordinate of hypocenter (as adopted in the numerical model)
	   	     
	   	     Example: 
	   	     675950.294467	 4973139.503191	  -6299.999930
	   	     668213.645510	 4979771.422233	  -3856.725658

	   	a11) mec_prop.dat contains the mechanical properties for the extended fault. 
	   	     (Example: L002/F00012/sism/mec_prop.dat)
	   	     Data are arranged in a 2D array with size [Nlayer x 3], where Nlayer is the number of layers 
	   	     crossed by the considered fault. 
	   	     The ith row (for i=1:Nlayers) provides the following information
	   	     1st column: Vp (m/s) 
	   	     2nd column: Vs (m/s) 
	   	     3rd column: rho (kg/m3) 
	   	     
	   	     Example: 
	   	     2300 1200 2100
	   	     3500 2100 2200
	   	     4750 2750 2400 
	   	     6340 3670 2800
	   	     
	        ATTENTION! File names are mandatory!
	    
        b) sism.srcmod is a directory containing .scrmod files. 
		   The .srcmod files (Example: Aquila_Ameri2012.scrmod) provide the co-seismic slip 
		   distribution in the following format: a matrix of slip values (in m) with size equal 
		   to Nx*Ny, where Nx is the number of sub-faults along strike and Ny is the number of 
		   subfautls down dip, the fault origin is the uppermost point of the rupture plane at
		   zero strike and zero dip. (Note: the format is the same as the one adopted in the 
		   finite-soruce rupture model database, i.e., http://www.seismo.ethz.ch/static/srcmod/.) 
        
        c) scen_par.dat is a file containing the SCENARIO parameters. 
          Earthquake scenario data are arranged in a 2D array with size [Nscen x 14], where 
          Nscen is the total number of scenarios to be considered. Thereofore, each row corresponds
          to a different earthquake scenario. 
          The ith row (i=1:Nscen) includes the following information: 
          1st column: scenario id 
          2nd column: fault ID
          3rd column: slip id (see slip_models.dat at point d)
          4th column: hypo id (see list hypocenter.dat at point a10) 
          5th column: L0/Lmax = distance along strike of rupture scenario from FO, 
                      distance is normalized wrt Lmax of causative fault.
          6th column: W0/Wmax = distance down dip of rupture scenario from FO, 
                      distance is normalized wrt Wmax of causative fault.
          7th column: L = Length of eqk scenario (in m)
          8th column: W = Width of eqk scenario (in m)
          9th column: Mw = Moment magnitude of eqk scenario
          10th column: Vr = rupture velocity (in m/s) of eqk scenario 
          11th column: tau  = rise time (in s) of eqk scenario
          12th column: rake = rake angle (in degrees) of eqk scenario
          13th column: iscale = logical variable, if 1 a scale factor is applied to the input 
                                slip distribution (as given by the *.srcmod files) to make the 
                                total seismic moment of the eqk scenario consistent with the given Mw
          14th column: icrsp = logical variable, if 1 correlated random source parameters are 
                               generated for rise time, rupture velocity, and rake angle 
                               (the mean values are the ones given above) 
           
           Example: row starting with 112 corresponds to the scenario E00112 on the database  
           http://95.110.233.181/terremoti/. 
           
        d) slip_models.dat contains a list of slip pattern distributions that can be used for generating a 
        particular eqk scenario along with a given seismic fault. Each row provides the name of the *.srcmod file 
        included in the sism.srcmod directory (see point b) 
        
        e) crsp.dat contains the input parameters for correlated random source parameters
		     (for further details see Smerzini and Villani, BSSA, 2012). 
		     Note: the present version works only when the fault size of the selected scenario matches exactly 
		     the size of the fault as generated in cubit (fault.e). 
		     The following parameters must be provided: 
		     tag_rake: logical variabile, if = 1 the program generates random source parameters for the rake angle
		     cov_rake: coefficient of variation for rake angle (between 0 and 1)
		     type_psd_rake: type of Power Spectral Density  for rake (0 = Gaussian, 1 = Exponential; 2 = Von Karman )
		     eta_rake: correlation coefficient between rake and slip distribution (between 0 and 1)
		     tag_rise: as tag_rake but for rise time 
		     cov_rise: as cov_rake but for rise time 
		     type_psd_rise: as type_psd_rake but for rise time 
		     tag_vr: as tag_rake but for rupture velocity 
		     cov_vr: as cov_rake but for rupture velocity 
		     type_psd_vr: as type_psd_rake but for rupture velocity 
		     vr_max: maximum rupture velocity (m/s), used when tag_vr = 1   
		     ax: correlation length in the along-strike direction (m)
		     Note: ax default = 10^(-2.5+1/2*Mw)*1000 Mai & Beroza (2002,JGR)  
		     ay: correlation length in the down-dip direction (m) 
		     Note: ay default = 10^(-1.5+1/3*Mw)*1000 Mai & Beroza (2002,JGR)
		 
        f) utmzone.dat is a list of UTM coordinates for the selected location. 
        Example: 
        L001   19H (for Santiago de Chile)
        L002   32N (for Emilia-Romagna)
        L003   59G (for Christchurch) 


%===============================================================================================================================%
Section 2. How to generate input files for a pre-existing earthquake scenario

STEP 0 - Run the matlab script SPEED_GUI_4_INPUT.
STEP 1 - In the box "Select a scenario from the database" insert the code of the desired scenario. 
         (Example: If you want SPEED input files for the scenario E00112 insert the number 112).
         The code univocally determines the correct location,fault and mecahnical properties for 
         the scenario, according to the list scen_par.dat. 
         Code: from 001 to 100 ---> Santiago de Chile ---> L001
               from 101 to 200 ---> Emilia Romagna ---> L002
               from 201 to 300 ---> Christchurch ---> L003
               from 301 to 400 ---> Wellington ---> L004        
               from 401 to 500 ---> Marsica ---> L005
               from 501 to 600 ---> Istanbul ---> L006
          
         Example: 
         Scenario code 112 in scen_par.dat correspond to location L002,
         fault id 12 (F00012), slip id 19 (line 19 "Emilia_Atzori20052012" in slip_models.dat) 
         and hypocenter id 1 (line 1 of L002/F00012/sism/hypocenter.dat)
         
         In the box "Insert table of materials" insert the name of the file where the material properties
         of the model are stored. 
         
         Example: "materials.ini" is the name of the file including the material properties for the selected model,
         saved in the folder Lxxx/Fyyyyy/mate/. 
         
         If you want to apply the not-honoring technique fill the boxes in the panel "NOT-HONORING" according
         to the user guide. Similarly for the panel "NON-LINEAR MATERIAL"; in particular give the name
         of the files where strain/damping and strain/GG0 curves are stored. Otherwhise do not fill the boxes.
         
         Example: For scenarios from 101 to 200 (L002) set CASE = 12, MATE = 1, TOL = 10 for the not-honoring
         case and MATE = 1, DEPTH = 150, FPEAK = 0.6667 for the non linear case. For the latter situation insert
         the names "curve_damp.ini" and curve_GG0.ini" in the Damping and G/G0 boxes respectively.
         (curve_damp.ini and curve_GG0.ini are saved in L001/F00012/mate).
         
STEP 2 - Fill the panel HEADER FILE according with the following rules:
         GRIDFILE: name of the file (without extension) containig the computational grid. The name has to be 
                   the same of the file that you have exported from cubit. 
                   Example: for using the mesh file EmiliaF12.e in L002/F00012/cub write in the box
                   "EmiliaF12"
         
         MATFILE: name of the file in which material properties, boundary conditions, interface conditions 
                  and external forces are stored
         MONFILE: name of the folder in which outout results produced by SPEED are stored. Default value "MONITORS"
         MPIFILE: name of the folder in which .mpi files produced by SPEED are stored. Default value "FILES_MPI" 
         BKPFILE: name of the folder in which snapshots of the solution are stored. Deaful value "empty".
         
         SPACE DISCRETIZATION: 
         	Select the space discretization between SEM or DGSEM.
         
         TIME DISCRETIZATION: 
         	Select time integration scheme between: leap-frog or 4th order Runge-Kutta.
                STARTIME: inital time for the simulation. If absent start time is equal to 0.
                STOPTIME: final time for the simulation.
                TIMESTEP: time step employed by the time integration scheme
                TMONITOR: number of time steps to make without saving output results
          
          OUTPUT OPTIONS: 
          	 Select the variables that you want to print in output.
          	 
          MLST OPTION: 
          	DEPTH = z-depth (with sign) up to which starting searching monitored points (Default value 0)
          	W/R = Write or Read MLST.input file. (Default value W)
          	
          SNAPSHOT:
          	Set the number of snapshots in which you want to save the solution (Default value is 0).
          	
STEP 3 - Save output results and run
         
         SAVE OUTPUT RESULTS: 
         	Select the Filesystem that you are using (Windows or Unix).
         	Set the name of the folder in which you want to store the output results. 
         	Default value is Ezzz where zzz is the code given in STEP 1. 
         	Example: For Code 130 the output results will be stored in L002/F00012/E00130.
         	
STEP 4 - Output files
         		 
         Output files generated by SPEED_GUI_4_INPUT are organized as follows:
         	figures - contains extended fault plot         
                sism - contains a brief resume of the fault features
                input4speed - folder containing input files for running SPEED code.
                

%===============================================================================================================================%
Section 3. How to generate input files for a new earthquake scenario                   
         
STEP 0 - Run the matlab script SPEED_GUI_4_INPUT.
STEP 1 - Fill the panels "Create a new scenario" and "Fault Geometry" according to your model. In paritcular fill
	 the boxes:
	 
	       "Create a new scenario"
	       	Mw: Moment magnitude of eqk scenario 
 	      	Slip: Select a slip model from the database (slip_models.dat, see point d) in Section 2)
 	      	Scale: Select the button if you want to scale the input slip distribution (as given by the *.srcmod
                 files) to make the total seismic moment of the eqk scenario consistent with the given Mw
 	      	Hypo: define the (x,y,z) coordinates (in m) for the hypocenter
 	      	L: Lenght of eak scenario (in m)
 	      	W: Width of eqk scenario (in m)
 	      	L0/LMAX: normalized distance along strike of rupture scenario from FO wrt Lmax of the fault
 	      	W0/WMAX: normalized distance down dip of rupture scenario from FO wrt Wmax of the fault
 	      	VR: rupture velocity (in m/s) of eqk scenario 
 	      	Rise time: rise time (in s) of eqk scenario
 	      	Rake: rake angle (in degrees) of eqk scenario
          
         "Fault Geometry"
         	Fault name: F00000
         	LMAX: length of the fault as implemented in the numerical model (in m)
         	WMAX: width of the fault as implemented in the numerical model (in m)
         	Strike: strike angle (in degrees)
         	Dip: Dip angle (in degrees)
         	F0: (x,y,z) coordinates (in m) of the Fault Origin (FO), i.e., 
         	     the uppermost fault point at zero strike and zero dip. 
         	
         	Random Source Paramters: Select the button if you want to generate correlated random
         	                         source parameters for rise time, rupture velocity and rake angle 
         	                         (the mean values are the ones given above)

	   	     
         In the box "Insert table of materials" insert the name of the file where the material properties
         of the model are stored. 
         
         Example: "materials.ini" is the name of the containing the material properties for the selected model,
         saved in the folder L000/F00000/mate/. 
         
         If you wanto to apply the not-honoring technique fill the boxes in the panel "NOT-HONORING" according
         to the user guide. Similarly for the panel "NON-LINEAR MATERIAL"; in particular give the name
         of the files where strain/damping and strain/GG0 curves are stored. Otherwhise do not fill the boxes.
                  
STEP 2, STEP 3 and STEP 4 - See Section 2.


Section 4. Running SPEED_GUI_4_INPUT
	When running SPEED_GUI_4_INPUT, the user should ask these questions: 
		1-Do you want to convert EXODUS files in ASCII files? (1=YES)
			Set 1 if it is the first run and you want to convert the files exported 
			from cubit to ascii files. For unix user this operation has to be made
			before running SPEED_GUI_4_INPUT using the script file ncdumps.sh.
			(Example: ./ncdumps.sh L001/F00012/cub)  
		
		2-Do you want to convert ASCII files to .mesh files ? (1=YES)
			Set 1 if it is the first run and you want to convert the ascii files to input files for SPEED.

      A copy of the files will be stored in the folder input4speed. For further runs
      on the same dataset type 0 to speedup the code. 

      
       After the execution of SPEED_GUI_4_INPUT, in the file speed.log you can find the info printed on the command window
       during the process. 
         





